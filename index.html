<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Album Data Fetcher</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-green-400 mb-2">Spotify Album Analysis</h1>
            <p class="text-gray-400">Fetch and display album and artist details using the Spotify API.</p>
        </header>

        <!-- Configuration Section -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label for="tokenInput" class="block text-sm font-medium text-gray-400">Spotify Access Token (Required)</label>
                    <input type="text" id="tokenInput" placeholder="YOUR_SPOTIFY_API_ACCESS_TOKEN_HERE" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-green-500 focus:border-green-500">
                    <p class="text-xs text-red-400 mt-1">IMPORTANT: You must manually obtain a new, temporary Access Token from Spotify's API tools and paste it here.</p>
                </div>
                <div>
                    <label for="albumIdInput" class="block text-sm font-medium text-gray-400">Album ID</label>
                    <input type="text" id="albumIdInput" value="4aawyRNdmt39sgEaC2T70O" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-green-500 focus:border-green-500">
                    <p class="text-xs text-gray-500 mt-1">Example: "4aawyRNdmt39sgEaC2T70O" (Kendrick Lamar - DAMN.)</p>
                </div>
            </div>
            <button id="fetchButton" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                Fetch Album Data
            </button>
        </div>

        <!-- Result Display Section -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-white">Results</h2>
            <div id="loader" class="hidden text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-3"></div>
                <p>Fetching data...</p>
            </div>
            <div id="resultOutput" class="space-y-4 text-sm">
                <p class="text-gray-400" id="statusMessage">Enter your token and click 'Fetch Data' to begin.</p>
            </div>

            <!-- Error/Message Box -->
            <div id="messageBox" class="hidden mt-4 p-4 border rounded-lg" role="alert"></div>
        </div>
    </div>

    <script>
        // --- Utility Functions ---

        /**
         * Generic function to display a temporary message (error or success)
         * @param {string} message 
         * @param {boolean} isError 
         */
        function displayMessage(message, isError = false) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-900', 'bg-green-900', 'border-red-500', 'border-green-500');
            
            if (isError) {
                box.classList.add('bg-red-900', 'border-red-500', 'text-red-300');
            } else {
                box.classList.add('bg-green-900', 'border-green-500', 'text-green-300');
            }

            // Clear message after 5 seconds
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        /**
         * Converts milliseconds to mm:ss format.
         * @param {number} ms 
         * @returns {string}
         */
        function msToMinSec(ms) {
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // --- API Fetch Logic ---

        /**
         * Generic function to make a GET request to the Spotify API with retry logic.
         * @param {string} url 
         * @param {string} token 
         */
        async function getSpotifyData(url, token) {
            const headers = {
                "Authorization": `Bearer ${token}`
            };
            const maxRetries = 3;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, { headers });
                    
                    if (response.ok) {
                        return await response.json();
                    }

                    if (response.status === 401) {
                        throw new Error("401 Unauthorized. Check your Access Token.");
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const waitTime = Math.pow(2, attempt);
                        console.warn(`Rate limit hit (429). Retrying in ${waitTime} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime * 1000));
                        continue; 
                    } else {
                        throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    throw error; // Re-throw to be caught by the main fetch function
                }
            }
            throw new Error("Failed to fetch data after multiple retries.");
        }

        /**
         * Fetches extended album and artist details.
         * @param {string} albumId 
         * @param {string} token 
         */
        async function fetchExtendedAlbumDetails(albumId, token) {
            const extendedDetails = {};

            // 1. Fetch Album Data
            const albumUrl = `https://api.spotify.com/v1/albums/${albumId}`;
            const albumData = await getSpotifyData(albumUrl, token);

            if (!albumData) {
                extendedDetails.album_info_error = "Could not retrieve album data.";
                return extendedDetails;
            }

            // Extract Album Details
            extendedDetails.album_name = albumData.name;
            extendedDetails.album_type = albumData.album_type;
            extendedDetails.release_date = albumData.release_date;
            extendedDetails.total_tracks = albumData.total_tracks;
            extendedDetails.album_popularity = albumData.popularity;
            extendedDetails.label = albumData.label;
            extendedDetails.copyrights = albumData.copyrights.map(c => c.text);
            extendedDetails.image_url = albumData.images[0]?.url || 'https://placehold.co/300x300/10b981/ffffff?text=No+Image';

            // Process Tracks
            extendedDetails.tracks = albumData.tracks.items.map(track => ({
                name: track.name,
                duration: msToMinSec(track.duration_ms),
                track_number: track.track_number,
                explicit: track.explicit,
                preview_url: track.preview_url,
                artists: track.artists.map(a => a.name).join(', ')
            }));
            
            // 2. Fetch Artist Data (using the first artist from the album)
            const primaryArtist = albumData.artists[0];
            if (primaryArtist && primaryArtist.id) {
                const artistUrl = `https://api.spotify.com/v1/artists/${primaryArtist.id}`;
                const artistData = await getSpotifyData(artistUrl, token);

                if (artistData) {
                    extendedDetails.artist_name = artistData.name;
                    extendedDetails.artist_id = artistData.id;
                    extendedDetails.artist_popularity = artistData.popularity; // 0-100 score
                    extendedDetails.artist_followers = artistData.followers?.total;
                    extendedDetails.artist_genres = artistData.genres;
                    extendedDetails.artist_image_url = artistData.images[0]?.url || 'https://placehold.co/100x100/10b981/ffffff?text=Artist';
                } else {
                    extendedDetails.artist_info_error = "Could not retrieve artist data.";
                }
            }
            
            return extendedDetails;
        }

        // --- Rendering and Event Handling ---

        document.addEventListener('DOMContentLoaded', () => {
            const fetchButton = document.getElementById('fetchButton');
            const tokenInput = document.getElementById('tokenInput');
            const albumIdInput = document.getElementById('albumIdInput');
            const resultOutput = document.getElementById('resultOutput');
            const loader = document.getElementById('loader');
            const statusMessage = document.getElementById('statusMessage');

            fetchButton.addEventListener('click', async () => {
                const token = tokenInput.value.trim();
                const albumId = albumIdInput.value.trim();
                
                // 1. Validation
                if (!token || token.toUpperCase() === "YOUR_SPOTIFY_API_ACCESS_TOKEN_HERE") {
                    displayMessage("Please enter a valid Spotify Access Token.", true);
                    return;
                }
                if (!albumId) {
                    displayMessage("Please enter an Album ID.", true);
                    return;
                }

                // 2. UI State: Start Loading
                resultOutput.innerHTML = '';
                statusMessage.textContent = '';
                loader.classList.remove('hidden');
                fetchButton.disabled = true;

                try {
                    // 3. Fetch Data
                    const result = await fetchExtendedAlbumDetails(albumId, token);

                    // 4. Render Results
                    if (Object.keys(result).length > 0) {
                        renderResults(result, resultOutput);
                    } else {
                        statusMessage.textContent = "No data returned. Check the console for errors.";
                    }
                    displayMessage("Data successfully fetched!", false);

                } catch (error) {
                    console.error("Fetch failed:", error);
                    statusMessage.textContent = `Error: ${error.message}. Please verify your Access Token and Album ID.`;
                    displayMessage(`An error occurred: ${error.message}`, true);
                } finally {
                    // 5. UI State: Stop Loading
                    loader.classList.add('hidden');
                    fetchButton.disabled = false;
                }
            });

            /**
             * Renders the fetched data into the result container.
             * @param {object} data 
             * @param {HTMLElement} container 
             */
            function renderResults(data, container) {
                container.innerHTML = ''; // Clear previous content

                const cardClasses = "bg-gray-700 p-4 rounded-xl shadow-inner border border-gray-600";
                const labelClasses = "font-medium text-green-400";
                const valueClasses = "text-gray-200";

                // --- Album Summary Card ---
                const albumCard = document.createElement('div');
                albumCard.className = `flex flex-col md:flex-row gap-6 ${cardClasses} mb-6`;
                
                // Album Image
                albumCard.innerHTML += `
                    <div class="flex-shrink-0">
                        <img src="${data.image_url}" alt="Album Art" class="w-full h-auto md:w-48 md:h-48 rounded-lg object-cover shadow-xl">
                    </div>
                `;

                // Album Details
                let albumDetails = `
                    <div class="flex-grow">
                        <h3 class="text-3xl font-bold mb-2 text-white">${data.album_name}</h3>
                        <p class="text-xl text-gray-400 mb-4">${data.artist_name || 'N/A'}</p>
                        
                        <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                            <div><span class="${labelClasses}">Type:</span> <span class="${valueClasses}">${data.album_type}</span></div>
                            <div><span class="${labelClasses}">Release Date:</span> <span class="${valueClasses}">${data.release_date}</span></div>
                            <div><span class="${labelClasses}">Total Tracks:</span> <span class="${valueClasses}">${data.total_tracks}</span></div>
                            <div><span class="${labelClasses}">Popularity Score:</span> <span class="${valueClasses}">${data.album_popularity || 'N/A'} / 100</span></div>
                            <div class="col-span-2"><span class="${labelClasses}">Label:</span> <span class="${valueClasses}">${data.label}</span></div>
                        </div>
                        <div class="mt-4 text-xs text-gray-500 italic">${data.copyrights.join('; ')}</div>
                    </div>
                `;
                albumCard.innerHTML += albumDetails;
                container.appendChild(albumCard);

                // --- Artist Details Card ---
                const artistCard = document.createElement('div');
                artistCard.className = cardClasses + ' mb-6';
                artistCard.innerHTML = `
                    <h3 class="text-2xl font-semibold mb-3 text-white flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Artist Details: ${data.artist_name || 'N/A'}
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <div><span class="${labelClasses}">Followers:</span> <span class="${valueClasses}">${data.artist_followers ? data.artist_followers.toLocaleString() : 'N/A'}</span></div>
                        <div><span class="${labelClasses}">Popularity:</span> <span class="${valueClasses}">${data.artist_popularity || 'N/A'} / 100</span></div>
                        <div class="sm:col-span-3"><span class="${labelClasses}">Genres:</span> <span class="${valueClasses}">${data.artist_genres ? data.artist_genres.join(', ') : 'N/A'}</span></div>
                        ${data.artist_info_error ? `<div class="col-span-3 text-red-400">${data.artist_info_error}</div>` : ''}
                    </div>
                `;
                container.appendChild(artistCard);

                // --- Track List ---
                const tracksContainer = document.createElement('div');
                tracksContainer.className = cardClasses;
                tracksContainer.innerHTML = `
                    <h3 class="text-2xl font-semibold mb-4 text-white flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v14M9 19c-3.866 0-7 3.134-7 7s3.134 7 7 7h12c3.866 0 7-3.134 7-7v-14M9 19V6l12-3v14M9 19c-3.866 0-7 3.134-7 7s3.134 7 7 7h12c3.866 0 7-3.134 7-7v-14" />
                        </svg>
                        Track List (${data.tracks.length} Songs)
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-600">
                            <thead>
                                <tr class="text-gray-400 uppercase text-xs font-semibold tracking-wider">
                                    <th class="px-3 py-2 text-left">#</th>
                                    <th class="px-3 py-2 text-left">Title</th>
                                    <th class="px-3 py-2 text-left">Artist(s)</th>
                                    <th class="px-3 py-2 text-right">Duration</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                ${data.tracks.map((track, index) => `
                                    <tr class="hover:bg-gray-700 transition duration-150">
                                        <td class="px-3 py-2 whitespace-nowrap text-gray-400">${track.track_number}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-white font-medium">${track.name} ${track.explicit ? '<span class="text-red-400 ml-1">(E)</span>' : ''}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-gray-300">${track.artists}</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-right text-gray-400">${track.duration}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(tracksContainer);
            }
        });
    </script>
</body>
</html>
