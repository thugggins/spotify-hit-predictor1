<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Popularity Predictor (ML Demo)</title>
    <!-- Load Tailwind CSS from CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Papa Parse for easy CSV handling in JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Custom styles for a dark, Spotify-inspired theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        :root {
            --spotify-green: #1DB954;
            --dark-background: #121212;
            --card-background: #1F1F1F;
            --text-light: #FFFFFF;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-background);
        }
        .predictor-card {
            background-color: var(--card-background);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom focus color */
        input:focus {
            border-color: var(--spotify-green) !important;
            box-shadow: 0 0 0 1px var(--spotify-green) !important;
        }
        select:focus {
            border-color: var(--spotify-green) !important;
            box-shadow: 0 0 0 1px var(--spotify-green) !important;
        }
        /* Style for read-only inputs */
        .input-locked {
            background-color: #303030; /* Darker background for locked state */
            color: #A0A0A0; /* Grayed out text */
            cursor: not-allowed;
            pointer-events: none; /* Disable mouse events on the field */
        }
        /* Hide number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Prediction Application Card -->
    <div class="predictor-card w-full max-w-lg shadow-2xl rounded-xl p-6 md:p-10 space-y-6">

        <h1 class="text-3xl font-extrabold text-center text-white">
            <span class="text-green-400">Spotify</span> Hit Predictor
        </h1>
        <p id="loading-message" class="text-center text-yellow-400 text-sm font-semibold">
            Loading data from 'spotify_data.csv'... Please wait.
        </p>
        <p id="ready-message" class="text-center text-gray-400 text-sm hidden">
            Select a track to see its prediction.
        </p>
        
        <!-- Input Form for Track Features -->
        <div class="space-y-4">

            <!-- Feature 0: Track Name (Dropdown) -->
            <div>
                <label for="track-select" class="block text-sm font-medium text-gray-300">Select Track</label>
                <select id="track-select" onchange="loadTrackFeatures()"
                       class="mt-1 w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 appearance-none transition duration-150"
                       disabled>
                    <option value="" disabled selected>Loading...</option>
                </select>
            </div>

            <!-- Track Metadata: Artist Name & Explicit Status -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Artist Name (Read-only/Editable based on selection) -->
                <div>
                    <label for="artist-name" class="block text-sm font-medium text-gray-300">Artist Name</label>
                    <input type="text" id="artist-name" value=""
                           class="mt-1 w-full p-3 bg-gray-700 text-gray-400 rounded-lg border border-gray-600 cursor-not-allowed">
                </div>

                <!-- Explicit Status (New Field - Read-only) -->
                <div>
                    <label for="explicit-status" class="block text-sm font-medium text-gray-300">Explicit Status</label>
                    <input type="text" id="explicit-status" value="" readonly
                           class="mt-1 w-full p-3 text-center rounded-lg border border-gray-600 font-bold">
                </div>
            </div>
            
            <!-- Feature 1: Artist Popularity -->
            <div>
                <label for="artist-pop" class="block text-sm font-medium text-gray-300">Artist Popularity (0-100)</label>
                <input type="number" id="artist-pop" min="0" max="100" value=""
                       class="mt-1 w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 transition duration-150">
                <p class="text-xs text-gray-500 mt-1">Represents the artist's overall success on Spotify.</p>
            </div>

            <!-- Feature 2: Track Duration (Minutes) -->
            <div>
                <label for="duration-min" class="block text-sm font-medium text-gray-300">Track Duration (Minutes)</label>
                <input type="number" id="duration-min" step="0.01" min="0.5" value=""
                       class="mt-1 w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 transition duration-150">
                <p class="text-xs text-gray-500 mt-1">e.g., 3 minutes 30 seconds = 3.5. Longer or shorter tracks can be outliers.</p>
            </div>
            
            <!-- Feature 3: Album Total Tracks -->
            <div>
                <label for="album-tracks" class="block text-sm font-medium text-gray-300">Album/Release Track Count</label>
                <input type="number" id="album-tracks" min="1" max="50" value=""
                       class="mt-1 w-full p-3 bg-gray-700 text-white rounded-lg border border-gray-600 transition duration-150">
                <p class="text-xs text-gray-500 mt-1">Number of tracks in the release (1 for a single, 10-20 for an album).</p>
            </div>
        </div>

        <!-- Prediction Button (Can be used after manual edits) -->
        <button onclick="handlePrediction()"
                class="w-full py-3 mt-4 text-lg font-bold text-black bg-green-500 rounded-lg shadow-md hover:bg-green-400 transition duration-300 ease-in-out transform hover:scale-[1.01]"
                id="predict-button" disabled>
            Predict Popularity
        </button>

        <!-- Prediction Output Display -->
        <div class="pt-6 border-t border-gray-700 space-y-3">
            <p class="text-center text-gray-300 font-medium">Predicted Popularity Score (0-100) for:</p>
            <p id="track-artist-summary" class="text-center text-xl font-bold text-white">
                ---
            </p>
            <div class="flex justify-center items-center">
                <div id="prediction-output" 
                     class="text-6xl font-black text-white bg-gray-800 p-4 w-32 h-32 flex items-center justify-center rounded-full border-4 border-gray-700 shadow-xl">
                    --
                </div>
            </div>
            <p id="prediction-message" class="text-center text-lg font-semibold text-green-400"></p>
        </div>

        <!-- ML Model Summary / Disclaimer -->
        <div class="mt-6 p-4 text-xs bg-gray-800 rounded-lg text-gray-400">
            <h3 class="font-bold text-gray-200 mb-1">Model Details (Simulated Linear Regression)</h3>
            <p>This is a pre-trained model for demonstration purposes. It uses the following weights based on general music industry trends:</p>
            <ul class="list-disc list-inside ml-2 mt-1 space-y-0.5">
                <li><span class="font-mono text-green-300">Bias:</span> 40.0 (Base Popularity)</li>
                <li><span class="font-mono text-green-300">Artist Popularity Weight:</span> +0.75 (Strong positive influence)</li>
                <li><span class="font-mono text-green-300">Duration Weight:</span> -2.5 (Slightly penalizes very short or very long tracks)</li>
                <li><span class="font-mono text-green-300">Album Tracks Weight:</span> -1.2 (Assumes singles/EPs have more focus than deep album cuts)</li>
            </ul>
        </div>
        
    </div>

    <script>
        // Global variable to store the parsed full dataset
        let TRACK_DATA = [];

        // Define the pre-trained coefficients (weights) for the Linear Regression model
        const MODEL_COEFFICIENTS = {
            bias: 40.0,
            artistPopWeight: 0.75,
            durationWeight: -2.5,
            albumTracksWeight: -1.2
        };

        // DOM elements for inputs
        const trackSelect = document.getElementById('track-select');
        const predictButton = document.getElementById('predict-button');
        const loadingMessage = document.getElementById('loading-message');
        const readyMessage = document.getElementById('ready-message');
        const artistNameInput = document.getElementById('artist-name');
        const explicitStatusInput = document.getElementById('explicit-status');
        const artistPopInput = document.getElementById('artist-pop');
        const durationMinInput = document.getElementById('duration-min');
        const albumTracksInput = document.getElementById('album-tracks');
        // Inputs that are controlled by the lock status
        const controllableInputs = [artistNameInput, artistPopInput, durationMinInput, albumTracksInput];


        /**
         * The core function that implements the machine learning prediction logic.
         */
        function predictPopularity(artistPop, durationMin, albumTracks) {
            const { bias, artistPopWeight, durationWeight, albumTracksWeight } = MODEL_COEFFICIENTS;

            // Simple Linear Regression Formula:
            let prediction = bias + 
                             (artistPop * artistPopWeight) + 
                             (durationMin * durationWeight) + 
                             (albumTracks * albumTracksWeight);

            // Clamp the result between 0 and 100, as popularity scores are capped.
            prediction = Math.max(0, Math.min(100, prediction));

            return prediction;
        }

        /**
         * Toggles the read-only state and styling for the numerical feature inputs.
         */
        function setFeatureLock(isLocked) {
            // Lock/Unlock artist name and numerical inputs
            controllableInputs.forEach(input => {
                input.readOnly = isLocked;
                input.classList.toggle('input-locked', isLocked);
                input.classList.toggle('bg-gray-700', !isLocked);
                input.classList.toggle('text-gray-400', isLocked);
                input.classList.toggle('text-white', !isLocked);
            });
            
            // Explicit status input is always display-only, but we update its style
            explicitStatusInput.classList.toggle('input-locked', isLocked);
        }

        /**
         * Updates the numerical feature inputs and triggers prediction based on the selected track.
         */
        function loadTrackFeatures() {
            const selectedTrackId = trackSelect.value;
            
            // Look up the track using the track ID
            const selectedTrack = TRACK_DATA.find(track => track.track_id === selectedTrackId);
            
            if (selectedTrack && selectedTrackId !== "0") {
                // Case 1: A specific track from the dataset is selected
                
                // Note: Data is read from the CSV as strings, so we ensure the correct types/parsing
                const duration = parseFloat(selectedTrack.track_duration_min);
                const artistPop = parseInt(selectedTrack.artist_popularity);
                const albumTracks = parseInt(selectedTrack.album_total_tracks);
                // Check if 'explicit' column value is 'TRUE' (case sensitive based on CSV standard)
                const isExplicit = selectedTrack.explicit && selectedTrack.explicit.toUpperCase() === 'TRUE';


                artistNameInput.value = selectedTrack.artist_name;
                artistPopInput.value = isNaN(artistPop) ? '' : artistPop;
                durationMinInput.value = isNaN(duration) ? '' : duration.toFixed(2);
                albumTracksInput.value = isNaN(albumTracks) ? '' : albumTracks;
                
                // Set the Explicit Status display
                const statusText = isExplicit ? 'Explicit' : 'Clean';
                const statusColor = isExplicit ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300';
                
                explicitStatusInput.value = statusText;
                explicitStatusInput.className = `mt-1 w-full p-3 text-center rounded-lg border border-gray-600 font-bold ${statusColor}`;

                setFeatureLock(true); // Lock features when using dataset value
                
                // Immediately run prediction after loading features
                handlePrediction();

            } else {
                // Case 2: Manual Input is selected (id=0)
                artistNameInput.value = 'Custom Artist';
                artistPopInput.value = '70';
                durationMinInput.value = '3.5';
                albumTracksInput.value = '12';
                
                // Clear and reset the Explicit Status display for manual mode
                explicitStatusInput.value = 'N/A';
                explicitStatusInput.className = `mt-1 w-full p-3 text-center rounded-lg border border-gray-600 font-bold bg-gray-700 text-gray-400`;
                
                setFeatureLock(false); // Unlock features for manual editing

                // Update summary for manual track
                document.getElementById('track-artist-summary').textContent = `Custom Track by Custom Artist`;
                // Run prediction for the default manual values
                handlePrediction();
            }
        }

        /**
         * Handles user interaction, gathers inputs, performs validation, and displays the prediction.
         */
        function handlePrediction() {
            const isManualInput = trackSelect.value === "0";

            // Get names: Artist name comes from the input field (editable or locked).
            let artistName = artistNameInput.value.trim() || 'Unknown Artist';
            let trackName;

            if (!isManualInput) {
                // Pull the track name directly from the selected option text
                trackName = trackSelect.options[trackSelect.selectedIndex].text.trim() || 'Untitled Track';
            } else {
                trackName = 'Custom Track';
            }


            // Get numerical input values
            const artistPop = parseFloat(artistPopInput.value);
            const durationMin = parseFloat(durationMinInput.value);
            const albumTracks = parseInt(albumTracksInput.value, 10);

            // Get output elements
            const outputElement = document.getElementById('prediction-output');
            const messageElement = document.getElementById('prediction-message');
            const summaryElement = document.getElementById('track-artist-summary');
            
            // Update summary immediately
            summaryElement.textContent = `${trackName} by ${artistName}`;

            // --- Basic Input Validation ---
            if (isNaN(artistPop) || artistPop < 0 || artistPop > 100 ||
                isNaN(durationMin) || durationMin < 0 || 
                isNaN(albumTracks) || albumTracks < 1) {
                
                outputElement.textContent = 'Err';
                outputElement.className = `text-6xl font-black text-white bg-gray-800 p-4 w-32 h-32 flex items-center justify-center rounded-full border-4 border-red-500 shadow-xl transition-all duration-500`;
                messageElement.textContent = 'Please enter valid numerical values for all features.';
                messageElement.className = 'text-center text-lg font-semibold text-red-500';
                return;
            }

            // --- Run Prediction ---
            const predictedScore = predictPopularity(artistPop, durationMin, albumTracks);

            // --- Update UI ---
            const roundedScore = Math.round(predictedScore);
            outputElement.textContent = roundedScore;
            
            // Determine display style and message based on the score
            let colorClass = 'border-gray-500';
            let message = "A niche track, potentially a deep cut or older release.";

            if (roundedScore >= 80) {
                colorClass = 'border-green-500';
                message = "ðŸ”¥ Mega Hit Potential! High probability of trending.";
            } else if (roundedScore >= 60) {
                colorClass = 'border-yellow-500';
                message = "â­ Strong Performer. Likely to be included in popular playlists.";
            } else if (roundedScore >= 40) {
                colorClass = 'border-blue-500';
                message = "ðŸ“ˆ Moderate Success. Solid track for the artist's discography.";
            } else {
                colorClass = 'border-red-500';
                message = "ðŸ“‰ Low Popularity. May be an album filler or highly experimental.";
            }
            
            outputElement.className = `text-6xl font-black text-white bg-gray-800 p-4 w-32 h-32 flex items-center justify-center rounded-full border-4 ${colorClass} shadow-xl transition-all duration-500`;
            messageElement.textContent = message;
            messageElement.className = 'text-center text-lg font-semibold ' + (roundedScore >= 80 ? 'text-green-400' : 'text-gray-400');
        }

        /**
         * Parses the CSV data and populates the dropdown.
         */
        function parseAndPopulateData(results) {
            // results.data is an array of objects where keys are the column headers
            TRACK_DATA = results.data;
            
            // Remove any rows where the track_id or track_name might be missing or the header row itself
            // We use a property that is unique and necessary: track_id
            TRACK_DATA = TRACK_DATA.filter(row => row.track_id && row.track_id !== 'track_id');

            // 1. Clear the initial 'Loading...' option
            trackSelect.innerHTML = ''; 

            // 2. Add Manual Input option
            const manualOption = document.createElement('option');
            manualOption.value = "0"; // Use 0 to signify manual input
            manualOption.textContent = "--- Manual Input / Custom Track ---";
            trackSelect.appendChild(manualOption);

            // 3. Add tracks from the loaded dataset
            TRACK_DATA.forEach(track => {
                const option = document.createElement('option');
                // Use track_id as the unique identifier for the value
                option.value = track.track_id; 
                option.textContent = track.track_name; 
                trackSelect.appendChild(option);
            });
            
            // Enable all controls now that data is loaded
            trackSelect.disabled = false;
            predictButton.disabled = false;
            loadingMessage.classList.add('hidden');
            readyMessage.classList.remove('hidden');

            // Set the first track (the first one loaded from CSV) as default and load features
            // Note: We skip the first item (Manual Input) and select the second option in the list
            trackSelect.selectedIndex = 1; 
            loadTrackFeatures();
            console.log(`Successfully loaded and parsed ${TRACK_DATA.length} tracks.`);
        }

        /**
         * Initializes the app by fetching the CSV data.
         */
        function initializeApp() {
            // This is the critical change: fetching the external CSV file.
            Papa.parse('spotify_data.csv', { 
                download: true, // Fetch the file from the relative path
                header: true,   // Treat the first row as headers
                skipEmptyLines: true,
                complete: parseAndPopulateData,
                error: (error) => {
                    // Update error message to reflect the new file name
                    loadingMessage.textContent = `Error loading data: ${error.message}. Please ensure 'spotify_data.csv' is uploaded to your GitHub repository.`;
                    loadingMessage.classList.remove('text-yellow-400');
                    loadingMessage.classList.add('text-red-500');
                    console.error("Papa Parse Error:", error);
                }
            });
        }

        // Initialize the app on page load
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
</html>
