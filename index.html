import requests
import json
import time

# NOTE: This script is designed to demonstrate the API logic.
# You must obtain a valid Spotify API Access Token and replace the placeholder below.
# A typical flow involves client credentials or authorization code flow to get this token.
MOCK_ACCESS_TOKEN = "YOUR_SPOTIFY_API_ACCESS_TOKEN_HERE"
ALBUM_ID_TO_FETCH = "4aawyRNdmt39sgEaC2T70O" # Example: Kendrick Lamar - DAMN.

def get_spotify_data(url, token):
    """
    Generic function to make a GET request to the Spotify API with retry logic.
    """
    headers = {
        "Authorization": f"Bearer {token}"
    }
    max_retries = 3
    for attempt in range(max_retries):
        try:
            response = requests.get(url, headers=headers)
            response.raise_for_status() # Raises an HTTPError for bad responses (4xx or 5xx)
            return response.json()
        except requests.exceptions.HTTPError as e:
            if response.status_code == 401:
                # Token is expired or invalid
                print("ERROR: 401 Unauthorized. Check your MOCK_ACCESS_TOKEN.")
                return None
            elif response.status_code == 429 and attempt < max_retries - 1:
                # Rate limit hit, wait and retry
                wait_time = 2 ** attempt # Exponential backoff
                print(f"Rate limit hit. Waiting for {wait_time} seconds...")
                time.sleep(wait_time)
            else:
                print(f"HTTP Error {response.status_code}: {e}")
                return None
        except requests.exceptions.RequestException as e:
            print(f"A general request error occurred: {e}")
            return None
    print("Failed to fetch data after multiple retries.")
    return None

def fetch_extended_album_details(album_id, token):
    """
    Fetches comprehensive data for an album, including track details and
    related artist metrics (followers, popularity).
    """
    base_url = "https://api.spotify.com/v1"
    
    # ----------------------------------------------------
    # 1. Fetch Album Details and Tracks (One API Call)
    # ----------------------------------------------------
    print(f"Fetching Album details for ID: {album_id}")
    album_url = f"{base_url}/albums/{album_id}"
    album_data = get_spotify_data(album_url, token)
    
    if not album_data:
        return {"error": "Could not retrieve album data."}

    # Extract primary artist ID from the first artist in the list
    try:
        artist_id = album_data['artists'][0]['id']
    except (IndexError, KeyError):
        return {"error": "Album data is missing primary artist ID."}

    # Extract all required album/track details
    tracks_list = []
    for track in album_data.get('tracks', {}).get('items', []):
        tracks_list.append({
            "name": track.get('name'),
            "duration_ms": track.get('duration_ms'),
            "is_explicit": track.get('explicit'),
            "track_number": track.get('track_number')
        })

    extended_details = {
        "album_name": album_data.get('name'),
        "album_type": album_data.get('album_type'), # e.g., 'album', 'single', 'compilation'
        "release_date": album_data.get('release_date'),
        "label": album_data.get('label'),
        "total_tracks": album_data.get('total_tracks'),
        "primary_artist_name": album_data['artists'][0]['name'],
        "tracks": tracks_list
    }

    # ----------------------------------------------------
    # 2. Fetch Artist Details (Second API Call)
    # ----------------------------------------------------
    print(f"Fetching Artist details for ID: {artist_id}")
    artist_url = f"{base_url}/artists/{artist_id}"
    artist_data = get_spotify_data(artist_url, token)
    
    if artist_data:
        extended_details["artist_popularity"] = artist_data.get('popularity') # 0-100 score
        extended_details["artist_followers"] = artist_data.get('followers', {}).get('total')
        extended_details["artist_genres"] = artist_data.get('genres')
    else:
        extended_details["artist_info_error"] = "Could not retrieve artist data."


    return extended_details

if __name__ == "__main__":
    if MOCK_ACCESS_TOKEN == "YOUR_SPOTIFY_API_ACCESS_TOKEN_HERE":
        print("!!! WARNING: Please replace MOCK_ACCESS_TOKEN with a valid token before running this script. !!!")
        print("This script will run but will likely fail with a 401 Unauthorized error until a real token is provided.")
    
    result = fetch_extended_album_details(ALBUM_ID_TO_FETCH, MOCK_ACCESS_TOKEN)
    
    print("\n--- EXTENDED ALBUM AND ARTIST DATA ---")
    print(json.dumps(result, indent=4))

# Function to convert milliseconds to mm:ss format for better readability
def ms_to_min_sec(ms):
    seconds = int((ms / 1000) % 60)
    minutes = int((ms / (1000 * 60)) % 60)
    return f"{minutes:02d}:{seconds:02d}"

# Example of how you would format the output for tracks:
# print("\n--- Track List ---")
# for track in result.get('tracks', []):
#     duration_str = ms_to_min_sec(track['duration_ms'])
#     explicit_status = "Explicit" if track['is_explicit'] else "Clean"
#     print(f"Track {track['track_number']}. {track['name']} ({duration_str}) - {explicit_status}")
